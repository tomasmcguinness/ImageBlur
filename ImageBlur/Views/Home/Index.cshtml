@{
    ViewBag.Title = "Index";
}
<!DOCTYPE html>
<html>
<head>
    <title>Image Blur</title>
    <script src="~/Scripts/jquery-1.8.0.min.js"></script>
    <script src="~/Scripts/jquery.Jcrop.min.js"></script>
</head>
<body onload="init()">
    <script>
        var currentFileName = null;
        var jcrop = null;

        function init() {
            console.log("Init()");
            $('#imageToBlur').Jcrop({ onSelect: blurImage }, function () { jcrop = this; });
            var dropArea = document.getElementById("dropspot");
            dropArea.addEventListener("drop", acceptImage, false);
            dropArea.addEventListener("dragover", doNothing, false);
        }

        function dragEnter(event) {
            console.log("dragEnter event fired!");
        }

        function acceptImage(event) {

            doNothing(event);

            $("#dropspot").hide();

            console.log("ondrop event fired!");

            var filelist = event.dataTransfer.files;
            var file = filelist[0];

            console.log(filelist.length + " file(s)");

            var reader = new FileReader();

            // init the reader event handlers
            reader.onload = handleReaderLoad;

            // begin the read operation
            reader.readAsDataURL(file);

            var formData = new FormData();
            formData.append('file', file);

            // now post a new XHR request
            var xhr = new XMLHttpRequest();
            xhr.open('POST', '/Home/UploadImage');

            xhr.onload = function () {
                if (xhr.status === 200) {
                    console.log('Image successfully uploaded with the name: ' + xhr.responseText);
                    currentFileName = xhr.responseText.substring(1, xhr.responseText.length - 1)
                } else {
                    console.log('Something went terribly wrong...' + +xhr.status);
                }
            };

            xhr.send(formData);
        }

        function handleReaderLoad(evt) {
            console.log("Image successfully read from disk");

            $("#imageToBlur").show();

            var img = document.getElementById("imageToBlur");
            img.src = evt.target.result;
        }

        function blurImage(c) {

            $("#processingDiv").show();

            console.log("Request section of image " + currentFileName + " to be blurred");
            console.log('Bounds: x=' + Math.round(c.x) + '&y=' + Math.round(c.y) + '&x2=' + Math.round(c.x2) + '&y2=' + Math.round(c.y2));

            jcrop.release();

            var xhr = new XMLHttpRequest();

            xhr.open('POST', '/Home/BlurSection?fileName=' + currentFileName + '&x=' + Math.round(c.x) + '&y=' + Math.round(c.y) + '&x2=' + Math.round(c.x2) + '&y2=' + Math.round(c.y2));

            xhr.onload = function () {
                if (xhr.status === 200) {
                    console.log("BlueSection Complete: " + xhr.status + ". Name for image: " + xhr.responseText);
                    console.log("Updating Onscreen Image...");

                    jcrop.destroy();

                    var img = document.getElementById("imageToBlur");
                    img.src = "/Home/Image?name=" + xhr.responseText.substring(1, xhr.responseText.length - 1);

                    $('#imageToBlur').Jcrop({ onSelect: blurImage }, function () { jcrop = this; });

                    currentFileName = xhr.responseText.substring(1, xhr.responseText.length - 1)

                    $("#processingDiv").hide();

                } else {
                    console.log('Something went terribly wrong...' + xhr.responseText);
                }
            };

            xhr.send();
        }

        // Prevents the event from continuing so our handlers can process the event.
        function doNothing(event) {
            event.stopPropagation();
            event.preventDefault();
        }

        function uploadFile() {
            var xhr = new XMLHttpRequest();
            var fd = document.getElementById('form1').getFormData();

            /* event listners */
            xhr.upload.addEventListener("progress", uploadProgress, false);
            xhr.addEventListener("load", uploadComplete, false);
            xhr.addEventListener("error", uploadFailed, false);
            xhr.addEventListener("abort", uploadCanceled, false);
            /* Be sure to change the url below to the url of your upload server side script */
            xhr.open("POST", "UploadMinimal.aspx");
            xhr.send(fd);
        }

    </script>
    <h2>Image Blur</h2>
    <p>
        Image Blur is a simple service that will apply a Gaussian blur to any part of an image, allowing you to mask information or details before uploading the image to your blog etc.
    </p>
    <p>
        To get started, just drag an image from your computer into the box below. Once the image is visible, you can select regions of the image. Each time you select a region, a blur will be applied. This can take a 
        few seconds, so please be patient. Once you're done, just right click and download the image.
    </p>

    <div id="dropspot" style="position: relative; min-width: 500px; height: 100px; margin-left: auto; margin-right: auto; background-color: lightgray;text-align: center;">
        <div>Drop an image here to get started</div>
    </div>
    <img id="imageToBlur" style="display: none; min-width: 50px; min-height: 50px;" />
    <div id="processingDiv" style="display: none;">
        PROCESSING:
            <img src="/Content/ajax-loader.gif" /><br />
    </div>

    <p>
        <button>Start Over</button>
        <button>Download the image</button>
    </p>
</body>
</html>
